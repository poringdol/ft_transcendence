{"ast":null,"code":"import consumer from \"./consumer\";\ndocument.addEventListener(\"turbolinks:load\", function () {\n  var KEYS = {\n    start_ball: 13,\n    up: 87,\n    down: 83,\n    color: 67,\n    reset_ball: 128,\n    // Кавиши управления\n    visit_page: 129,\n    leave_page: 130,\n    goal: 131,\n    end_game: 132,\n    start_game: 133,\n    update_state: 134\n  };\n  var MAX_RATE = 7;\n  var BRACKET_SPEED = 50;\n  var RADIUS = 8;\n  var COLOR = {\n    BRACKET1: \"#222AAA\",\n    BRACKET2: \"#991515\",\n    BALL: \"#FFCC00\",\n    CANVAS: \"#EEEEEE\"\n  };\n  var match_element = $(\"#MatchID\");\n  var MATCH_ID = match_element != null ? parseInt(match_element.attr(\"data-MatchID\")) : -1;\n  var MATCH;\n  var subscribe = 0;\n\n  if (typeof MATCH_ID !== \"undefined\" && MATCH_ID > 0) {\n    var leave_page = function leave_page() {\n      if (typeof MATCH !== \"undefined\" && MATCH.player != 0) {\n        if (typeof game !== \"undefined\") game.params.state = \"leave\";\n\n        if (MATCH.model.get(\"is_end\") == false) {\n          MATCH.model.set(\"is_player\".concat(MATCH.player, \"_online\"), false);\n          MATCH.model.save();\n\n          if (MATCH.model.get(\"is_inprogress\") == true || MATCH.model.get(\"is_inprogress\") == false && MATCH.model.get(\"is_end\") == false) {\n            // Если оба игрока покинули страницу с игрой, завершаем игру\n            if (MATCH.model.get(\"is_player1_online\") == false && MATCH.model.get(\"is_player2_online\") == false) {\n              $.post(\"/matches/end_game\", {\n                id: MATCH_ID\n              });\n              subscribe.perform(\"command\", {\n                match_id: MATCH_ID,\n                key_code: KEYS.end_game,\n                player: -1\n              });\n            } // Иначе засчитываем гол игроку, покинувшему страницу с игрой во время матча\n            else subscribe.perform(\"command\", {\n                match_id: MATCH_ID,\n                key_code: KEYS.leave_page,\n                player: MATCH.player\n              });\n          }\n        }\n      }\n\n      consumer.subscriptions.remove(subscribe);\n      $(\"body\").off();\n      return true;\n    };\n\n    subscribe = consumer.subscriptions.create({\n      channel: \"MatchChannel\",\n      match_id: MATCH_ID\n    }, {\n      connected: function connected() {\n        if (MATCH_ID > 0) {\n          console.log(\"Connected to match \".concat(MATCH_ID)); // При подключении к каналу создаем модель матча (фетчим данные из бд), создаем вью, в которой стартуем игру\n\n          MATCH = new App.Views.Match({\n            model: new App.Models.Match()\n          });\n        }\n      },\n      disconnected: function disconnected() {\n        if (MATCH_ID > 0) console.log(\"Disconnected from match \".concat(MATCH_ID));\n        consumer.subscriptions.remove(subscribe);\n      },\n      received: function received(data) {\n        var key_code = data.key_code;\n\n        if (key_code == KEYS.start_game) {\n          MATCH.renderGame(true);\n          MATCH.renderOnlineStatus(true, 1);\n          MATCH.renderOnlineStatus(true, 2);\n        } else if (typeof game !== \"undefined\") {\n          if (key_code == KEYS.down || key_code == KEYS.up) {\n            data.player == 1 ? game.objects.bracket1.y = parseInt(data.bracket1) : game.objects.bracket2.y = parseInt(data.bracket2);\n          } else if (key_code == KEYS.start_ball) {\n            game.kickBall();\n          } else if (key_code == KEYS.reset_ball) {\n            game.resetBall(data.player);\n          } else if (key_code == KEYS.leave_page) {\n            MATCH.renderOnlineStatus(false, data.player);\n\n            if (MATCH.player > 0) {\n              subscribe.perform(\"save_state\", {\n                match_id: MATCH_ID,\n                state: \"playerwait\",\n                player: MATCH.player,\n                key_code: KEYS.update_state\n              });\n              MATCH.model.set(\"is_player\".concat(data.player, \"_online\"), false);\n              MATCH.model.save();\n            }\n\n            game.goal(MATCH.player);\n          } else if (key_code == KEYS.visit_page) {\n            MATCH.renderOnlineStatus(true, data.player);\n          } else if (key_code == KEYS.end_game) {\n            game.params.state = \"stop\";\n            MATCH.model.set(\"is_inprogress\", false);\n            MATCH.model.set(\"is_end\", true); // Если победитель игры онлайн, то он завершает игру\n\n            if (MATCH.model.get(\"is_player\".concat(data.player, \"_online\")) == true) {\n              if (MATCH.player == data.player) $.post(\"/matches/end_game\", {\n                id: MATCH_ID\n              });\n            } // Иначе второй игрок матча завершает игру\n            else if (MATCH.player > 0) $.post(\"/matches/end_game\", {\n                id: MATCH_ID\n              });\n\n            setTimeout(function () {\n              MATCH.model.fetch({\n                success: MATCH.renderResult\n              });\n            }, 1000);\n          } else if (key_code == KEYS.update_state) {\n            game.params.state = data.state;\n            game.params.lastGoalPlayer = data.player;\n          } else if (key_code == KEYS.goal) {\n            game.params.state = data.state;\n            game.params.lastGoalPlayer = data.player;\n            MATCH.model.set(\"player\".concat(data.player, \"_score\"), data.score);\n            MATCH.renderScore(data.score, data.player);\n          }\n        }\n      }\n    }); // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // \n    // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // \n\n    window.App = {\n      Models: {},\n      Views: {}\n    }; //  MATCH              MODEL\n\n    App.Models.Match = Backbone.Model.extend({\n      url: \"/matches/match_users/\".concat(MATCH_ID)\n    }); //  MATCH              VIEW\n\n    App.Views.Match = Backbone.View.extend({\n      start_template: _.template($(\"#GameStartTemplate\").html()),\n      profile1_template: _.template($(\"#MatchUser1ProfileTemplate\").html()),\n      profile2_template: _.template($(\"#MatchUser2ProfileTemplate\").html()),\n      result_template: _.template($(\"#MatchResultTemplate\").html()),\n      initialize: function initialize() {\n        this.player = 0;\n\n        _.bindAll(this, \"init\");\n\n        this.model.fetch({\n          success: this.init\n        });\n      },\n      init: function init() {\n        var _this2 = this;\n\n        $(\"a\").on(\"click\", leave_page);\n        $(window).on(\"beforeunload\", leave_page); // Если игра завершена - рисуем результаты\n\n        if (this.model.get(\"is_end\") == true) {\n          this.renderResult();\n          return;\n        }\n\n        this.renderProfile1();\n        this.renderProfile2(); // 0 - наблюдатель, 1 или 2 - игрок\n\n        this.player = this.model.get(\"player1\").id == this.model.get(\"current_user\").id ? 1 : this.model.get(\"player2\") != null && this.model.get(\"player2\").id == this.model.get(\"current_user\").id ? 2 : 0;\n\n        if (this.player != 0) {\n          this.model.set(\"is_player\".concat(this.player, \"_online\"), true);\n          this.model.save().done(function () {\n            _this2.renderOnlineStatus(true, _this2.player);\n\n            subscribe.perform(\"command\", {\n              match_id: MATCH_ID,\n              key_code: KEYS.visit_page,\n              player: _this2.player\n            });\n          });\n        }\n\n        if (this.model.get(\"is_inprogress\") == true) {\n          this.renderGame(false);\n        } else if (this.model.get(\"is_player1_online\") && this.model.get(\"is_player2_online\")) {\n          this.model.save({\n            is_inprogress: true\n          }).done(function () {\n            subscribe.perform(\"command\", {\n              match_id: MATCH_ID,\n              key_code: KEYS.start_game\n            });\n          });\n        } else {\n          this.renderWaiting();\n        }\n      },\n      renderGame: function renderGame(is_newgame) {\n        var _this3 = this;\n\n        MATCH.model.fetch({\n          success: function success() {\n            _this3.renderProfile2();\n\n            var template = _this3.start_template();\n\n            $(\"#GameWrapper\").html(template);\n            window.game = new Game(_this3.player, is_newgame);\n            game.startGame();\n          }\n        });\n      },\n      renderProfile1: function renderProfile1() {\n        var template = this.profile1_template(this.model.attributes);\n        $(\"#MatchUser1Profile\").html(template);\n        this.renderOnlineStatus(this.model.get(\"is_player1_online\"), 1);\n      },\n      renderProfile2: function renderProfile2() {\n        var template = this.profile2_template(this.model.attributes);\n        $(\"#MatchUser2Profile\").html(template);\n        if (this.model.get(\"player2\") != null) this.renderOnlineStatus(this.model.get(\"is_player2_online\"), 2);\n      },\n      renderWaiting: function renderWaiting() {\n        $(\"#GameWrapper\").html(\"ОЖИДАЕМ ВТОРОГО ИГРОКА\");\n      },\n      renderResult: function renderResult() {\n        // Останавливаем цикл\n        if (typeof game !== \"undefined\") {\n          cancelAnimationFrame(game.requestLoop); // Убираем слушателей событий\n\n          document.removeEventListener(\"keydown\", game.keyDownEvent);\n        }\n\n        $(\"#MatchUser1Profile\").html(\"\");\n        $(\"#MatchUser2Profile\").html(\"\");\n        var template = MATCH.result_template(MATCH.model.attributes);\n        $(\"#GameWrapper\").html(template);\n\n        if (MATCH.model.get(\"is_ranked\") == true) {\n          var rating = MATCH.model.get(\"rating\");\n\n          if (MATCH.model.get(\"player1_score\") > MATCH.model.get(\"player2_score\")) {\n            $(\"#Player1Rating\").html(\"Rating:  <span style='color: green'>+\".concat(rating, \"</span>\"));\n            $(\"#Player2Rating\").html(\"Rating:  <span style='color: red'>-\".concat(rating, \"</span>\"));\n          } else if (MATCH.model.get(\"player1_score\") < MATCH.model.get(\"player2_score\")) {\n            $(\"#Player1Rating\").html(\"Rating:  <span style='color: red'>-\".concat(rating, \"</span>\"));\n            $(\"#Player2Rating\").html(\"Rating:  <span style='color: green'>+\".concat(rating, \"</span>\"));\n          }\n        }\n      },\n      renderOnlineStatus: function renderOnlineStatus(is_online, player) {\n        var content = is_online == true ? \"<span style='color: green'>Online</span>\" : \"<span style='color: red'>Offline</span>\";\n        $(\"#MatchPlayer\".concat(player, \"Online\")).html(content);\n        MATCH.model.set(\"is_player\".concat(player, \"_online\"), is_online);\n      },\n      renderScore: function renderScore(score, player) {\n        $(\"#MatchPlayer\".concat(player, \"Score\")).html(score);\n      }\n    }); // Опишем наши игровые объекты + научим их рисовать себя на канвасе и передвигаться\n\n    var Ball = function Ball() {\n      return {\n        radius: RADIUS,\n        color: COLOR.BALL,\n        x: 0,\n        y: 0,\n        yspeed: 0,\n        xspeed: 0,\n        bounce: 1.1,\n        // коофицент упругости - для ускорения шарика после отскока\n        render: function render(ctx) {\n          ctx.beginPath();\n          ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);\n          ctx.fillStyle = this.color;\n          ctx.fill();\n        },\n        // Передвижение шара всегда происходит с определенной скоростью \n        // поэтому мы не будем передавть x y для кастомного перемещения.\n        move: function move() {\n          this.x = this.x + this.xspeed;\n          this.y = this.y + this.yspeed;\n        }\n      };\n    }; // Блоки для отбивания шарика\n\n\n    var Bracket = function Bracket(color) {\n      return {\n        w: 10,\n        h: 100,\n        x: 0,\n        y: 0,\n        speed: BRACKET_SPEED,\n        color: color,\n        render: function render(ctx) {\n          ctx.fillStyle = this.color;\n          ctx.fillRect(this.x, this.y, this.w, this.h);\n        }\n      };\n    };\n\n    var Game = function Game(player, is_newgame) {\n      var _this = this; // Параметры игры\n\n\n      this.params = {\n        width: 960,\n        height: 600,\n        state: \"loading\",\n        // Состояние игры\n        lastGoalPlayer: 0\n      };\n\n      if (is_newgame == true) {\n        this.params.state = \"playerwait\";\n        this.params.lastGoalPlayer = 1;\n        subscribe.perform(\"save_state\", {\n          match_id: MATCH_ID,\n          state: \"playerwait\",\n          player: 1,\n          key_code: KEYS.update_state\n        });\n      } else {\n        subscribe.perform(\"get_state\", {\n          match_id: MATCH_ID,\n          key_code: KEYS.update_state\n        });\n      } // Сохраняем ссылки на canvas и контекст для дальнейшего рисования\n\n\n      this.canvasBlock = document.getElementById(\"gameCanvas\");\n      this.ctx = this.canvasBlock.getContext(\"2d\"); // Подписываемся на события кнопок, если пользователь участник игры\n\n      if (player > 0) {\n        // var keeDown = function (event) { _this.keyDownEvent.call(_this, event, player); }\n        // document.addEventListener(\"keydown\", _.throttle(keeDown, THROTTLE));\n        document.addEventListener(\"keydown\", function (event) {\n          _this.keyDownEvent.call(_this, event, player);\n        });\n      }\n\n      return this;\n    }; // Игровые методы\n\n\n    Game.prototype = {\n      startGame: function startGame() {\n        var _this = this;\n\n        this.objects = {\n          ball: new Ball(),\n          bracket1: new Bracket(COLOR.BRACKET1),\n          bracket2: new Bracket(COLOR.BRACKET2),\n          canvasColor: COLOR.CANVAS\n        }; // Стартовые позиции ракеток\n\n        this.objects.bracket1.x = 50;\n        this.objects.bracket1.y = this.params.height / 2 - this.objects.bracket1.h / 2;\n        this.objects.bracket2.x = this.params.width - 50;\n        this.objects.bracket2.y = this.params.height / 2 - this.objects.bracket1.h / 2;\n        this.loop(); // this.last_time = performance.now();\n        // this.curr_time = performance.now();\n      },\n      // Игровой цикл\n      loop: function loop() {\n        var _this = this; // if (this.curr_time - this.last_time > 200) {\n\n\n        this.logic(); // \tthis.last_time = this.curr_time;\n        // }\n\n        this.physic();\n        this.render(); // this.curr_time = performance.now()\n\n        if (this.params.state == \"stop\" || this.params.state == \"leave\") return; // Используем замыкание для передачи контекста\n\n        this.requestLoop = requestAnimationFrame(function () {\n          _this.loop.call(_this);\n        });\n      },\n      // Логика игры\n      logic: function logic() {\n        var ball = game.objects.ball; // Если сейчас идет игра\n\n        if (this.params.state == \"game\") {\n          // Шарик оказался за первым игроком\n          if (ball.x <= RADIUS * 2) this.goal(2); // Шарик оказался за вторым игроком\n\n          if (ball.x >= game.params.width - RADIUS * 2) this.goal(1);\n        } // Проверяем наличие победителя\n\n\n        if (MATCH.model.get(\"player1_score\") >= MAX_RATE && MATCH.player == 1) {\n          game.params.state = \"stop\";\n          setTimeout(function () {\n            subscribe.perform(\"command\", {\n              match_id: MATCH_ID,\n              key_code: KEYS.end_game,\n              player: 1\n            });\n          }, 300);\n        }\n\n        if (MATCH.model.get(\"player2_score\") >= MAX_RATE && MATCH.player == 2) {\n          game.params.state = \"stop\";\n          setTimeout(function () {\n            subscribe.perform(\"command\", {\n              match_id: MATCH_ID,\n              key_code: KEYS.end_game,\n              player: 2\n            });\n          }, 300);\n        }\n      },\n      // Физика игры\n      physic: function physic() {\n        var ball = game.objects.ball,\n            b1 = game.objects.bracket1,\n            b2 = game.objects.bracket2; // Передвигаем шар\n\n        game.objects.ball.move(); // Отскок слева\n\n        if (ball.x + ball.radius / 2 < 0) {\n          game.objects.ball.xspeed = -game.objects.ball.xspeed;\n        } // Отскок Справа\n\n\n        if (ball.x + ball.radius / 2 > game.params.width) {\n          game.objects.ball.xspeed = -game.objects.ball.xspeed;\n        } // Отскок от границ canvas по высоте\n\n\n        if (ball.y + ball.radius / 2 > game.params.height || ball.y + ball.radius / 2 < 0) {\n          game.objects.ball.yspeed = -game.objects.ball.yspeed;\n        } // Отскок шарика от 1 блока\n\n\n        if (ball.x <= 60 && ball.y >= b1.y && ball.y <= b1.y + b1.h) {\n          ball.xspeed = -ball.xspeed;\n          if (MATCH.model.get(\"addons\").addon1 == true) this.disco(); // Ускоряем шарик\n\n          if (MATCH.model.get(\"addons\").addon3 == true) ball.xspeed = ball.xspeed * ball.bounce;\n        } // Отскок шарика от 2 блока\n\n\n        if (ball.x >= this.params.width - 50 && ball.y >= b2.y && ball.y <= b2.y + b2.h) {\n          ball.xspeed = -ball.xspeed;\n          if (MATCH.model.get(\"addons\").addon1 == true) this.disco(); // Ускоряем шарик\n\n          if (MATCH.model.get(\"addons\").addon3 == true) ball.xspeed = ball.xspeed * ball.bounce;\n        } // В состоянии ожидания пуска шарика от ракетки игрока, выставляем шарик рядом с ракеткой забившего игрока\n\n\n        if (this.params.state == \"playerwait\") {\n          subscribe.perform(\"command\", {\n            match_id: MATCH_ID,\n            key_code: KEYS.reset_ball,\n            player: this.params.lastGoalPlayer\n          });\n        } // Не позволяем вылезать блокам за пределы canvas\n\n\n        if (b1.y <= 0) b1.y = 1;\n        if (b2.y <= 0) b2.y = 1;\n        if (b1.y + b1.h >= this.params.height) b1.y = this.params.height - b1.h;\n        if (b2.y + b2.h >= this.params.height) b2.y = this.params.height - b2.h;\n      },\n      // Рендер игры\n      render: function render() {\n        // Чистим канвас на каждом кадре\n        game.ctx.fillStyle = game.objects.canvasColor;\n        game.ctx.fillRect(0, 0, game.params.width, game.params.height);\n\n        if (MATCH.model.get(\"addons\").addon2 == true) {\n          game.objects.bracket1.color = this.randomColor();\n          game.objects.bracket2.color = this.randomColor();\n          game.objects.ball.color = this.randomColor();\n          game.objects.canvasColor = this.randomColor();\n        }\n\n        game.objects.ball.render(game.ctx);\n        game.objects.bracket1.render(game.ctx);\n        game.objects.bracket2.render(game.ctx);\n      },\n      // Инициализация игровых событий\n      keyDownEvent: function keyDownEvent(event, player) {\n        var kCode = event.keyCode;\n\n        if (kCode == KEYS.start_ball && game.params.state == \"playerwait\" && game.params.lastGoalPlayer == player) {\n          subscribe.perform(\"move_bracket\", {\n            match_id: MATCH_ID,\n            key_code: kCode\n          });\n          return;\n        }\n\n        var br1 = game.objects.bracket1.y;\n        var br2 = game.objects.bracket2.y;\n\n        if (kCode == KEYS.down) {\n          player == 1 ? br1 += game.objects.bracket1.speed : br2 += game.objects.bracket2.speed;\n          subscribe.perform(\"move_bracket\", {\n            match_id: MATCH_ID,\n            player: player,\n            key_code: kCode,\n            bracket1: br1,\n            bracket2: br2\n          });\n        } else if (kCode == KEYS.up) {\n          player == 1 ? br1 -= game.objects.bracket1.speed : br2 -= game.objects.bracket2.speed;\n          subscribe.perform(\"move_bracket\", {\n            match_id: MATCH_ID,\n            player: player,\n            key_code: kCode,\n            bracket1: br1,\n            bracket2: br2\n          });\n        } else if (kCode == KEYS.color) {\n          player == 1 ? game.objects.bracket1.color = this.randomColor() : game.objects.bracket2.color = this.randomColor();\n        } // // DEBUG\n\n\n        var keys = {\n          L: 76,\n          A: 65,\n          M: 77\n        }; // if (kCode == keys.L) { console.log(game.params.lastGoalPlayer) }\n        // if (kCode == keys.A) { console.log(game.params.state) }\n\n        if (kCode == keys.M) {\n          console.log(MATCH.player);\n        }\n      },\n      goal: function goal(lastGoalPlayer) {\n        if (MATCH.player == lastGoalPlayer) {\n          var score = MATCH.model.get(\"player\".concat(lastGoalPlayer, \"_score\")) + 1;\n          MATCH.model.set(\"player\".concat(lastGoalPlayer, \"_score\"), score);\n          MATCH.model.save();\n          game.params.state = \"playerwait\";\n          subscribe.perform(\"save_state\", {\n            match_id: MATCH_ID,\n            state: \"playerwait\",\n            player: lastGoalPlayer,\n            key_code: KEYS.goal,\n            score: score\n          });\n        }\n      },\n      // Выставление шарика на ракетку после гола\n      resetBall: function resetBall(player) {\n        game.objects.ball.xspeed = 0;\n        game.objects.ball.yspeed = 0;\n\n        if (player == 1) {\n          game.objects.ball.x = game.objects.bracket1.x + game.objects.bracket1.w + game.objects.ball.radius + 1;\n          game.objects.ball.y = game.objects.bracket1.y + game.objects.bracket1.h / 2;\n        } else if (player == 2) {\n          game.objects.ball.x = game.objects.bracket2.x - game.objects.ball.radius - 1;\n          game.objects.ball.y = game.objects.bracket2.y + game.objects.bracket2.h / 2;\n        }\n      },\n      // Пуск шарика после гола\n      kickBall: function kickBall() {\n        this.params.state = \"game\";\n        subscribe.perform(\"save_state\", {\n          match_id: MATCH_ID,\n          state: \"game\",\n          player: game.params.lastGoalPlayer,\n          key_code: KEYS.update_state\n        });\n        setTimeout(function () {\n          if (game.params.lastGoalPlayer == 1) {\n            game.objects.ball.xspeed = 3;\n            game.objects.ball.yspeed = 3;\n          } else {\n            game.objects.ball.xspeed = -3;\n            game.objects.ball.yspeed = -3;\n          }\n        }, 1000);\n      },\n      disco: function disco() {\n        game.objects.bracket1.color = this.randomColor();\n        game.objects.bracket2.color = this.randomColor();\n        game.objects.ball.color = this.randomColor();\n        game.objects.canvasColor = this.randomColor();\n      },\n      randomColor: function randomColor() {\n        var r = Math.floor(Math.random() * 256);\n        var g = Math.floor(Math.random() * 256);\n        var b = Math.floor(Math.random() * 256);\n        return \"rgb(\".concat(r, \", \").concat(g, \", \").concat(b, \")\");\n      }\n    };\n  }\n});","map":{"version":3,"sources":["/pingpong/app/javascript/channels/match_channel.js"],"names":["consumer","document","addEventListener","KEYS","start_ball","up","down","color","reset_ball","visit_page","leave_page","goal","end_game","start_game","update_state","MAX_RATE","BRACKET_SPEED","RADIUS","COLOR","BRACKET1","BRACKET2","BALL","CANVAS","match_element","$","MATCH_ID","parseInt","attr","MATCH","subscribe","player","game","params","state","model","get","set","save","post","id","perform","match_id","key_code","subscriptions","remove","off","create","channel","connected","console","log","App","Views","Match","Models","disconnected","received","data","renderGame","renderOnlineStatus","objects","bracket1","y","bracket2","kickBall","resetBall","setTimeout","fetch","success","renderResult","lastGoalPlayer","score","renderScore","window","Backbone","Model","extend","url","View","start_template","_","template","html","profile1_template","profile2_template","result_template","initialize","bindAll","init","on","renderProfile1","renderProfile2","done","is_inprogress","renderWaiting","is_newgame","Game","startGame","attributes","cancelAnimationFrame","requestLoop","removeEventListener","keyDownEvent","rating","is_online","content","Ball","radius","x","yspeed","xspeed","bounce","render","ctx","beginPath","arc","Math","PI","fillStyle","fill","move","Bracket","w","h","speed","fillRect","_this","width","height","canvasBlock","getElementById","getContext","event","call","prototype","ball","canvasColor","loop","logic","physic","requestAnimationFrame","b1","b2","addon1","disco","addon3","addon2","randomColor","kCode","keyCode","br1","br2","keys","L","A","M","r","floor","random","g","b"],"mappings":"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","sourcesContent":["import consumer from \"./consumer\"\n\ndocument.addEventListener(\"turbolinks:load\", () => {\n\t\n\tconst KEYS = {\tstart_ball: 13, up: 87, down: 83, color: 67, reset_ball: 128,\t// Кавиши управления\n\t\t\t\t\tvisit_page: 129, leave_page: 130, goal: 131, end_game: 132, start_game: 133, update_state: 134, };\n\tconst MAX_RATE = 7;\n\tconst BRACKET_SPEED = 50;\n\tconst RADIUS = 8;\n\tconst COLOR = { BRACKET1: \"#222AAA\", BRACKET2: \"#991515\", BALL: \"#FFCC00\", CANVAS: \"#EEEEEE\" };\n\n\tconst match_element = $(\"#MatchID\");\n\tconst MATCH_ID = (match_element != null) ? parseInt(match_element.attr(\"data-MatchID\")) : -1;\n\t\n\tlet MATCH;\n\tlet subscribe = 0;\n\n\tif (typeof MATCH_ID !== \"undefined\" && MATCH_ID > 0) {\n\t\tfunction leave_page() {\n\t\t\tif (typeof MATCH !== \"undefined\" && MATCH.player != 0) {\n\n\t\t\t\tif (typeof game !== \"undefined\")\n\t\t\t\t\tgame.params.state = \"leave\";\n\n\t\t\t\tif (MATCH.model.get(\"is_end\") == false) {\n\t\t\t\t\tMATCH.model.set(`is_player${MATCH.player}_online`, false);\n\t\t\t\t\tMATCH.model.save();\n\t\t\t\t\n\t\t\t\t\tif (MATCH.model.get(\"is_inprogress\") == true || MATCH.model.get(\"is_inprogress\") == false && MATCH.model.get(\"is_end\") == false) {\n\t\t\t\t\t\t// Если оба игрока покинули страницу с игрой, завершаем игру\n\t\t\t\t\t\tif (MATCH.model.get(\"is_player1_online\") == false && MATCH.model.get(\"is_player2_online\") == false) {\n\t\t\t\t\t\t\t$.post(\"/matches/end_game\", { id: MATCH_ID });\n\t\t\t\t\t\t\tsubscribe.perform(\"command\", { match_id: MATCH_ID, key_code: KEYS.end_game, player: -1 })\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Иначе засчитываем гол игроку, покинувшему страницу с игрой во время матча\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tsubscribe.perform(\"command\", { match_id: MATCH_ID, key_code: KEYS.leave_page, player: MATCH.player });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tconsumer.subscriptions.remove(subscribe);\n\t\t\t$(\"body\").off();\n\t\t\treturn true;\n\t\t}\n\t\tsubscribe = consumer.subscriptions.create({ channel: \"MatchChannel\", match_id: MATCH_ID}, {\n\n\t\t\tconnected() {\n\t\t\t\tif (MATCH_ID > 0) {\n\t\t\t\t\tconsole.log(`Connected to match ${MATCH_ID}`);\n\t\n\t\t\t\t\t// При подключении к каналу создаем модель матча (фетчим данные из бд), создаем вью, в которой стартуем игру\n\t\t\t\t\tMATCH = new App.Views.Match({ model: new App.Models.Match() });\n\t\t\t\t}\n\t\t\t},\n\t\t\t\t\n\t\t\tdisconnected() {\n\t\t\t\tif (MATCH_ID > 0)\n\t\t\t\t\tconsole.log(`Disconnected from match ${MATCH_ID}`);\n\t\t\t\tconsumer.subscriptions.remove(subscribe);\n\t\t\t},\n\t\n\t\t\treceived(data) {\n\n\t\t\t\tlet key_code = data.key_code;\n\t\t\t\t\n\t\t\t\tif (key_code == KEYS.start_game) {\n\t\t\t\t\tMATCH.renderGame(true);\n\t\t\t\t\tMATCH.renderOnlineStatus(true, 1);\n\t\t\t\t\tMATCH.renderOnlineStatus(true, 2);\n\t\t\t\t}\n\t\t\t\telse if (typeof game !== \"undefined\") {\n\n\t\t\t\t\tif (key_code == KEYS.down || key_code == KEYS.up) {\n\t\t\t\t\t\tdata.player == 1 ? game.objects.bracket1.y = parseInt(data.bracket1)\n\t\t\t\t\t\t\t\t\t\t : game.objects.bracket2.y = parseInt(data.bracket2);\n\t\t\t\t\t}\n\t\t\t\t\telse if (key_code == KEYS.start_ball) {\n\t\t\t\t\t\tgame.kickBall();\n\t\t\t\t\t}\n\t\t\t\t\telse if (key_code == KEYS.reset_ball) {\n\t\t\t\t\t\tgame.resetBall(data.player);\n\t\t\t\t\t}\n\t\t\t\t\telse if (key_code == KEYS.leave_page) {\n\t\t\t\t\t\tMATCH.renderOnlineStatus(false, data.player);\n\t\t\t\t\t\tif (MATCH.player > 0) {\n\t\t\t\t\t\t\tsubscribe.perform(\"save_state\", { match_id: MATCH_ID, state: \"playerwait\", player: MATCH.player, key_code: KEYS.update_state });\n\t\t\t\t\t\t\tMATCH.model.set(`is_player${data.player}_online`, false);\n\t\t\t\t\t\t\tMATCH.model.save();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tgame.goal(MATCH.player);\n\t\t\t\t\t}\n\t\t\t\t\telse if (key_code == KEYS.visit_page) {\n\t\t\t\t\t\tMATCH.renderOnlineStatus(true, data.player);\n\t\t\t\t\t}\n\t\t\t\t\telse if (key_code == KEYS.end_game) {\n\t\t\t\t\t\tgame.params.state = \"stop\";\n\t\t\t\t\t\tMATCH.model.set(\"is_inprogress\", false);\n\t\t\t\t\t\tMATCH.model.set(\"is_end\", true);\n\n\t\t\t\t\t\t// Если победитель игры онлайн, то он завершает игру\n\t\t\t\t\t\tif (MATCH.model.get(`is_player${data.player}_online`) == true) {\n\t\t\t\t\t\t\tif (MATCH.player == data.player)\n\t\t\t\t\t\t\t\t$.post(\"/matches/end_game\", { id: MATCH_ID });\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Иначе второй игрок матча завершает игру\n\t\t\t\t\t\telse if (MATCH.player > 0)\n\t\t\t\t\t\t\t$.post(\"/matches/end_game\", { id: MATCH_ID });\n\t\t\t\t\t\t\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tMATCH.model.fetch({\n\t\t\t\t\t\t\t\tsuccess: MATCH.renderResult \n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t)}, 1000);\n\t\t\t\t\t}\n\t\t\t\t\telse if (key_code == KEYS.update_state) {\n\t\t\t\t\t\tgame.params.state = data.state;\n\t\t\t\t\t\tgame.params.lastGoalPlayer = data.player;\n\t\t\t\t\t}\n\t\t\t\t\telse if (key_code == KEYS.goal) {\n\t\t\t\t\t\tgame.params.state = data.state;\n\t\t\t\t\t\tgame.params.lastGoalPlayer = data.player;\n\n\t\t\t\t\t\tMATCH.model.set(`player${data.player}_score`, data.score);\n\t\t\t\t\t\tMATCH.renderScore(data.score, data.player);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\t// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // \n\t\t\n\t\t// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // \n\n\t\twindow.App = {\n\t\t\tModels: {},\n\t\t\tViews: {}\n\t\t};\n\t\t\n\t\t//  MATCH              MODEL\n\t\tApp.Models.Match = Backbone.Model.extend({ url: `/matches/match_users/${MATCH_ID}` });\n\t\t\n\t\t//  MATCH              VIEW\n\t\tApp.Views.Match = Backbone.View.extend({\n\n\t\t\tstart_template: _.template($(\"#GameStartTemplate\").html()),\n\t\t\tprofile1_template: _.template($(\"#MatchUser1ProfileTemplate\").html()),\n\t\t\tprofile2_template: _.template($(\"#MatchUser2ProfileTemplate\").html()),\n\t\t\tresult_template: _.template($(\"#MatchResultTemplate\").html()),\n\t\t\n\t\t\tinitialize: function () {\n\t\t\t\tthis.player = 0;\n\t\t\n\t\t\t\t_.bindAll(this, \"init\");\n\t\t\t\tthis.model.fetch({ success: this.init })\n\t\t\t},\n\t\t\t\n\t\t\tinit: function () {\n\n\t\t\t\t$(\"a\").on(\"click\", leave_page);\n\t\t\t\t$(window).on(\"beforeunload\", leave_page);\n\n\t\t\t\t// Если игра завершена - рисуем результаты\n\t\t\t\tif (this.model.get(\"is_end\") == true) {\n\t\t\t\t\tthis.renderResult();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.renderProfile1();\n\t\t\t\tthis.renderProfile2();\n\n\t\t\t\t// 0 - наблюдатель, 1 или 2 - игрок\n\t\t\t\tthis.player = (this.model.get(\"player1\").id == this.model.get(\"current_user\").id) ? 1 :\n\t\t\t\t\t\t\t  (this.model.get(\"player2\") != null &&\n\t\t\t\t\t\t\t   this.model.get(\"player2\").id == this.model.get(\"current_user\").id) ? 2 : 0;\n\t\t\t\t\t\t\t   \n\t\t\t\tif (this.player != 0) {\n\t\t\t\t\tthis.model.set(`is_player${this.player}_online`, true);\n\t\t\t\t\tthis.model.save().done(() => {\n\t\t\t\t\t\tthis.renderOnlineStatus(true, this.player);\n\t\t\t\t\t\tsubscribe.perform(\"command\", { match_id: MATCH_ID, key_code: KEYS.visit_page, player: this.player });\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tif (this.model.get(\"is_inprogress\") == true) {\n\t\t\t\t\tthis.renderGame(false);\n\t\t\t\t}\n\t\t\t\telse if (this.model.get(\"is_player1_online\") && this.model.get(\"is_player2_online\")) {\n\t\t\t\t\tthis.model.save({ is_inprogress: true }).done(function () {\n\t\t\t\t\t\tsubscribe.perform(\"command\", { match_id: MATCH_ID, key_code: KEYS.start_game });\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.renderWaiting();\n\t\t\t\t}\n\t\t\t},\n\t\t\n\t\t\trenderGame: function (is_newgame) {\n\t\t\t\tMATCH.model.fetch({\n\t\t\t\t\tsuccess: () => {\n\t\t\t\t\t\tthis.renderProfile2();\n\t\t\t\t\t\tlet template = this.start_template();\n\t\t\t\t\t\t$(\"#GameWrapper\").html(template);\n\t\t\n\t\t\t\t\t\twindow.game = new Game(this.player, is_newgame);\n\t\t\t\t\t\tgame.startGame();\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\n\t\t\trenderProfile1: function () {\n\t\t\t\tlet template = this.profile1_template(this.model.attributes);\n\t\t\t\t$(\"#MatchUser1Profile\").html(template);\n\t\t\t\tthis.renderOnlineStatus(this.model.get(\"is_player1_online\"), 1);\n\t\t\t},\n\t\t\t\n\t\t\trenderProfile2: function () {\n\t\t\t\tlet template = this.profile2_template(this.model.attributes);\n\t\t\t\t$(\"#MatchUser2Profile\").html(template);\n\t\t\t\tif (this.model.get(\"player2\") != null)\n\t\t\t\t\tthis.renderOnlineStatus(this.model.get(\"is_player2_online\"), 2);\n\t\t\t},\n\t\t\t\n\t\t\trenderWaiting: function () {\n\t\t\t\t$(\"#GameWrapper\").html(\"ОЖИДАЕМ ВТОРОГО ИГРОКА\");\n\t\t\t},\n\t\t\t\n\t\t\trenderResult: function () {\n\n\t\t\t\t// Останавливаем цикл\n\t\t\t\tif (typeof game !== \"undefined\") {\n\t\t\t\t\tcancelAnimationFrame(game.requestLoop);\n\t\t\t\t\t// Убираем слушателей событий\n\t\t\t\t\tdocument.removeEventListener(\"keydown\", game.keyDownEvent);\n\t\t\t\t}\n\n\t\t\t\t$(\"#MatchUser1Profile\").html(\"\");\n\t\t\t\t$(\"#MatchUser2Profile\").html(\"\");\n\t\t\t\t\n\t\t\t\tlet template = MATCH.result_template(MATCH.model.attributes);\n\t\t\t\t$(\"#GameWrapper\").html(template);\n\t\t\t\t\n\t\t\t\tif (MATCH.model.get(\"is_ranked\") == true) {\n\t\t\t\t\tlet rating = MATCH.model.get(\"rating\");\n\n\t\t\t\t\tif (MATCH.model.get(\"player1_score\") > MATCH.model.get(\"player2_score\")) {\n\t\t\t\t\t\t$(\"#Player1Rating\").html(`Rating:  <span style='color: green'>+${rating}</span>`)\n\t\t\t\t\t\t$(\"#Player2Rating\").html(`Rating:  <span style='color: red'>-${rating}</span>`)\n\t\t\t\t\t}\n\t\t\t\t\telse if (MATCH.model.get(\"player1_score\") < MATCH.model.get(\"player2_score\")) {\n\t\t\t\t\t\t$(\"#Player1Rating\").html(`Rating:  <span style='color: red'>-${rating}</span>`)\n\t\t\t\t\t\t$(\"#Player2Rating\").html(`Rating:  <span style='color: green'>+${rating}</span>`)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\trenderOnlineStatus: function (is_online, player) {\n\t\t\t\tlet content = (is_online == true)\n\t\t\t\t\t\t\t? \"<span style='color: green'>Online</span>\"\n\t\t\t\t\t\t\t: \"<span style='color: red'>Offline</span>\";\n\t\t\t\t$(`#MatchPlayer${player}Online`).html(content);\n\t\t\t\tMATCH.model.set(`is_player${player}_online`, is_online);\n\t\t\t},\n\t\t\t\n\t\t\trenderScore: function (score, player) {\n\t\t\t\t$(`#MatchPlayer${player}Score`).html(score);\n\t\t\t},\n\t\t})\n\n\t\t// Опишем наши игровые объекты + научим их рисовать себя на канвасе и передвигаться\n\t\tvar Ball = function () {\n\t\t\treturn {\n\t\t\t\tradius: RADIUS,\n\t\t\t\tcolor: COLOR.BALL,\n\t\t\t\tx: 0,\n\t\t\t\ty: 0,\n\t\t\t\tyspeed: 0,\n\t\t\t\txspeed: 0,\n\t\t\t\tbounce: 1.1, // коофицент упругости - для ускорения шарика после отскока\n\t\t\t\trender: function (ctx) {\n\t\t\t\t\tctx.beginPath();\n\t\t\t\t\tctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);\n\t\t\t\t\tctx.fillStyle = this.color;\n\t\t\t\t\tctx.fill();\n\t\t\t\t},\n\t\t\t\t// Передвижение шара всегда происходит с определенной скоростью \n\t\t\t\t// поэтому мы не будем передавть x y для кастомного перемещения.\n\t\t\t\tmove: function () {\n\t\t\t\t\tthis.x = this.x + this.xspeed;\n\t\t\t\t\tthis.y = this.y + this.yspeed;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\t\n\t\t// Блоки для отбивания шарика\n\t\tvar Bracket = function (color) {\n\t\t\treturn {\n\t\t\t\tw: 10,\n\t\t\t\th: 100,\n\t\t\t\tx: 0,\n\t\t\t\ty: 0,\n\t\t\t\tspeed: BRACKET_SPEED,\n\t\t\t\tcolor: color,\n\t\t\t\trender: function (ctx) {\n\t\t\t\t\tctx.fillStyle = this.color;\n\t\t\t\t\tctx.fillRect(this.x, this.y, this.w, this.h);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\t\n\t\tvar Game = function (player, is_newgame) {\n\n\t\t\tvar _this = this;\n\t\t\t\n\t\t\t// Параметры игры\n\t\t\tthis.params = {\n\t\t\t\twidth: 960,\n\t\t\t\theight: 600,\n\t\t\t\tstate: \"loading\", // Состояние игры\n\t\t\t\tlastGoalPlayer: 0,\n\t\t\t};\n\n\t\t\tif (is_newgame == true) {\n\t\t\t\tthis.params.state = \"playerwait\";\n\t\t\t\tthis.params.lastGoalPlayer = 1;\n\n\t\t\t\tsubscribe.perform(\"save_state\", { match_id: MATCH_ID, state: \"playerwait\", player: 1, key_code: KEYS.update_state });\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsubscribe.perform(\"get_state\", { match_id: MATCH_ID, key_code: KEYS.update_state });\n\t\t\t}\n\t\t\n\t\t\t// Сохраняем ссылки на canvas и контекст для дальнейшего рисования\n\t\t\tthis.canvasBlock = document.getElementById(\"gameCanvas\");\n\t\t\tthis.ctx = this.canvasBlock.getContext(\"2d\");\n\t\t\t\n\t\t\t// Подписываемся на события кнопок, если пользователь участник игры\n\t\t\tif (player > 0) {\n\t\t\t\t// var keeDown = function (event) { _this.keyDownEvent.call(_this, event, player); }\n\t\t\t\t// document.addEventListener(\"keydown\", _.throttle(keeDown, THROTTLE));\n\t\t\t\tdocument.addEventListener(\"keydown\", function (event) {\n\t\t\t\t\t_this.keyDownEvent.call(_this, event, player);\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn this;\n\t\t};\n\t\t\n\t\t// Игровые методы\n\t\tGame.prototype = {\n\n\t\t\tstartGame: function () {\n\n\t\t\t\tvar _this = this;\n\n\t\t\t\tthis.objects = {\n\t\t\t\t\tball: new Ball(),\n\t\t\t\t\tbracket1: new Bracket(COLOR.BRACKET1),\n\t\t\t\t\tbracket2: new Bracket(COLOR.BRACKET2),\n\t\t\t\t\tcanvasColor: COLOR.CANVAS\n\t\t\t\t};\n\n\t\t\t\t// Стартовые позиции ракеток\n\t\t\t\tthis.objects.bracket1.x = 50;\n\t\t\t\tthis.objects.bracket1.y = this.params.height / 2 - this.objects.bracket1.h / 2;\n\t\t\t\t\n\t\t\t\tthis.objects.bracket2.x = this.params.width - 50;\n\t\t\t\tthis.objects.bracket2.y = this.params.height / 2 - this.objects.bracket1.h / 2;\n\t\t\t\t\n\t\t\t\tthis.loop();\n\t\t\t\t// this.last_time = performance.now();\n  \t\t\t\t// this.curr_time = performance.now();\n\t\t\t},\n\t\t\n\t\t\t// Игровой цикл\n\t\t\tloop: function () {\n\t\t\t\tvar _this = this;\n\t\t\t\t\n\t\t\t\t// if (this.curr_time - this.last_time > 200) {\n\t\t\t\tthis.logic();\n\t\t\t\t// \tthis.last_time = this.curr_time;\n\t\t\t\t// }\n\t\t\t\tthis.physic();\n\t\t\t\tthis.render();\n\t\t\t\t// this.curr_time = performance.now()\n\t\t\n\t\t\t\tif (this.params.state == \"stop\" || this.params.state == \"leave\")\n\t\t\t\t\treturn;\n\t\t\t\t\n\t\t\t\t// Используем замыкание для передачи контекста\n\t\t\t\tthis.requestLoop = requestAnimationFrame(function() {\n\t\t\t\t\t_this.loop.call(_this);\n\t\t\t\t});\n\t\t\t},\n\t\t\n\t\t\t// Логика игры\n\t\t\tlogic: function () {\n\t\t\n\t\t\t\tvar ball = game.objects.ball;\n\t\t\n\t\t\t\t// Если сейчас идет игра\n\t\t\t\tif (this.params.state == \"game\") {\n\n\t\t\t\t\t// Шарик оказался за первым игроком\n\t\t\t\t\tif (ball.x <= RADIUS * 2)\n\t\t\t\t\t\tthis.goal(2);\n\t\t\t\t\t\n\t\t\t\t\t// Шарик оказался за вторым игроком\n\t\t\t\t\tif (ball.x >= game.params.width - RADIUS * 2)\n\t\t\t\t\t\tthis.goal(1);\n\t\t\t\t}\n\n\t\t\t\t// Проверяем наличие победителя\n\t\t\t\tif (MATCH.model.get(\"player1_score\") >= MAX_RATE && MATCH.player == 1) {\n\t\t\t\t\tgame.params.state = \"stop\";\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tsubscribe.perform(\"command\", { match_id: MATCH_ID, key_code: KEYS.end_game, player: 1 });\n\t\t\t\t\t}, 300)\n\t\t\t\t}\n\t\t\t\tif (MATCH.model.get(\"player2_score\") >= MAX_RATE && MATCH.player == 2) {\n\t\t\t\t\tgame.params.state = \"stop\";\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tsubscribe.perform(\"command\", { match_id: MATCH_ID, key_code: KEYS.end_game, player: 2 });\n\t\t\t\t\t}, 300)\n\t\t\t\t}\n\t\t\t},\n\t\t\n\t\t\t// Физика игры\n\t\t\tphysic: function () {\n\n\t\t\t\tvar ball = game.objects.ball,\n\t\t\t\tb1 = game.objects.bracket1,\n\t\t\t\tb2 = game.objects.bracket2;\n\t\t\t\t\n\t\t\t\t// Передвигаем шар\n\t\t\t\tgame.objects.ball.move();\n\t\t\n\t\t\t\t// Отскок слева\n\t\t\t\tif (ball.x + ball.radius/2 < 0) {\n\t\t\t\t\tgame.objects.ball.xspeed = -game.objects.ball.xspeed;\n\t\t\t\t}\n\t\t\t\t// Отскок Справа\n\t\t\t\tif (ball.x + ball.radius/2 > game.params.width) {\n\t\t\t\t\tgame.objects.ball.xspeed = -game.objects.ball.xspeed;\n\t\t\t\t}\n\t\t\t\t// Отскок от границ canvas по высоте\n\t\t\t\tif (ball.y + ball.radius/2 > game.params.height || ball.y + ball.radius/2 < 0) {\n\t\t\t\t\tgame.objects.ball.yspeed = -game.objects.ball.yspeed;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// Отскок шарика от 1 блока\n\t\t\t\tif (ball.x <= 60 && ball.y >= b1.y && ball.y <= b1.y+b1.h) {\n\t\t\t\t\tball.xspeed = -ball.xspeed;\n\t\t\t\t\tif (MATCH.model.get(\"addons\").addon1 == true)\n\t\t\t\t\t\tthis.disco();\n\t\t\t\t\t// Ускоряем шарик\n\t\t\t\t\tif (MATCH.model.get(\"addons\").addon3 == true)\n\t\t\t\t\t\tball.xspeed = ball.xspeed * ball.bounce;\n\t\t\t\t}\n\t\t\t\t// Отскок шарика от 2 блока\n\t\t\t\tif (ball.x >= this.params.width - 50 && ball.y >= b2.y && ball.y <= b2.y + b2.h) {\n\t\t\t\t\tball.xspeed = -ball.xspeed;\n\t\t\t\t\tif (MATCH.model.get(\"addons\").addon1 == true)\n\t\t\t\t\t\tthis.disco();\n\t\t\t\t\t// Ускоряем шарик\n\t\t\t\t\tif (MATCH.model.get(\"addons\").addon3 == true)\n\t\t\t\t\t\tball.xspeed = ball.xspeed * ball.bounce;\n\t\t\t\t}\n\n\t\t\t\t// В состоянии ожидания пуска шарика от ракетки игрока, выставляем шарик рядом с ракеткой забившего игрока\n\t\t\t\tif (this.params.state == \"playerwait\") {\n\t\t\t\t\tsubscribe.perform(\"command\", { match_id: MATCH_ID, key_code: KEYS.reset_ball, player: this.params.lastGoalPlayer });\n\t\t\t\t}\n\t\t\n\t\t\t\t// Не позволяем вылезать блокам за пределы canvas\n\t\t\t\tif (b1.y <= 0) b1.y = 1; \n\t\t\t\tif (b2.y <= 0) b2.y = 1; \n\t\t\t\tif (b1.y + b1.h >= this.params.height) b1.y = this.params.height - b1.h;\n\t\t\t\tif (b2.y + b2.h >= this.params.height) b2.y = this.params.height - b2.h;\n\t\t\t},\n\t\t\n\t\t\t// Рендер игры\n\t\t\trender: function () {\n\t\t\t\t// Чистим канвас на каждом кадре\n\t\t\t\tgame.ctx.fillStyle = game.objects.canvasColor;\n\t\t\t\tgame.ctx.fillRect(0,0, game.params.width, game.params.height);\n\n\t\t\t\tif (MATCH.model.get(\"addons\").addon2 == true) {\n\t\t\t\t\tgame.objects.bracket1.color = this.randomColor();\n\t\t\t\t\tgame.objects.bracket2.color = this.randomColor();\n\t\t\t\t\tgame.objects.ball.color = this.randomColor();\n\t\t\t\t\tgame.objects.canvasColor = this.randomColor();\n\t\t\t\t}\n\t\t\t\tgame.objects.ball.render(game.ctx);\n\t\t\t\tgame.objects.bracket1.render(game.ctx);\n\t\t\t\tgame.objects.bracket2.render(game.ctx);\n\t\t\t},\n\t\t\n\t\t\t// Инициализация игровых событий\n\t\t\tkeyDownEvent: function (event, player) {\n\t\t\t\n\t\t\t\tvar kCode = event.keyCode;\n\n\t\t\t\tif (kCode == KEYS.start_ball && game.params.state == \"playerwait\" && game.params.lastGoalPlayer == player) {\n\t\t\t\t\tsubscribe.perform(\"move_bracket\", { match_id: MATCH_ID, key_code: kCode });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tlet br1 = game.objects.bracket1.y;\n\t\t\t\tlet br2 = game.objects.bracket2.y;\n\t\t\t\t\n\t\t\t\tif (kCode == KEYS.down) {\n\t\t\t\t\tplayer == 1 ? (br1 += game.objects.bracket1.speed) : (br2 += game.objects.bracket2.speed);\n\t\t\t\t\tsubscribe.perform(\"move_bracket\", { match_id: MATCH_ID, player: player, key_code: kCode, bracket1: br1, bracket2: br2});\n\t\t\t\t}\n\t\t\t\telse if (kCode == KEYS.up) {\n\t\t\t\t\tplayer == 1 ? (br1 -= game.objects.bracket1.speed) : (br2 -= game.objects.bracket2.speed);\n\t\t\t\t\tsubscribe.perform(\"move_bracket\", { match_id: MATCH_ID, player: player, key_code: kCode, bracket1: br1, bracket2: br2});\n\t\t\t\t}\n\t\t\t\telse if (kCode == KEYS.color) {\n\t\t\t\t\tplayer == 1 ? game.objects.bracket1.color = this.randomColor() :\n\t\t\t\t\t\t\t\t  game.objects.bracket2.color = this.randomColor();\n\t\t\t\t}\n\n\t\t\t// // DEBUG\n\t\t\tconst keys = { L: 76, A: 65, M: 77}\n\t\t\t// if (kCode == keys.L) { console.log(game.params.lastGoalPlayer) }\n\t\t\t// if (kCode == keys.A) { console.log(game.params.state) }\n\t\t\tif (kCode == keys.M) { console.log(MATCH.player) }\n\n\t\t\t},\n\n\t\t\tgoal: function (lastGoalPlayer) {\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tif (MATCH.player == lastGoalPlayer) {\n\t\t\t\t\tlet score = MATCH.model.get(`player${lastGoalPlayer}_score`) + 1;\n\t\t\t\t\t\n\t\t\t\t\tMATCH.model.set(`player${lastGoalPlayer}_score`, score);\n\t\t\t\t\tMATCH.model.save();\n\t\t\t\t\tgame.params.state = \"playerwait\";\n\t\t\t\t\tsubscribe.perform(\"save_state\", { match_id: MATCH_ID, state: \"playerwait\", player: lastGoalPlayer, key_code: KEYS.goal, score: score });\n\t\t\t\t}\n\t\t\t},\n\t\t\t\n\t\t\t// Выставление шарика на ракетку после гола\n\t\t\tresetBall: function (player) {\n\t\t\t\tgame.objects.ball.xspeed = 0;\n\t\t\t\tgame.objects.ball.yspeed = 0;\n\n\t\t\t\tif (player == 1) {\n\t\t\t\t\tgame.objects.ball.x = game.objects.bracket1.x + game.objects.bracket1.w + game.objects.ball.radius + 1;\n\t\t\t\t\tgame.objects.ball.y = game.objects.bracket1.y + game.objects.bracket1.h / 2;\n\t\t\t\t}\n\t\t\t\telse if (player == 2) {\n\t\t\t\t\tgame.objects.ball.x = game.objects.bracket2.x - game.objects.ball.radius - 1;\n\t\t\t\t\tgame.objects.ball.y = game.objects.bracket2.y + game.objects.bracket2.h / 2;\n\t\t\t\t}\n\t\t\t},\n\t\t\t\n\t\t\t// Пуск шарика после гола\n\t\t\tkickBall: function () {\n\t\t\t\tthis.params.state = \"game\";\n\t\t\t\tsubscribe.perform(\"save_state\", { match_id: MATCH_ID, state: \"game\", player: game.params.lastGoalPlayer, key_code: KEYS.update_state });\n\n\t\t\t\tsetTimeout(function () {\n\t\t\t\t\tif (game.params.lastGoalPlayer == 1) {\n\t\t\t\t\t\tgame.objects.ball.xspeed = 3;\n\t\t\t\t\t\tgame.objects.ball.yspeed = 3;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tgame.objects.ball.xspeed = -3;\n\t\t\t\t\t\tgame.objects.ball.yspeed = -3;\n\t\t\t\t\t}\n\t\t\t\t}, 1000);\n\t\t\t},\n\n\t\t\tdisco: function () {\n\t\t\t\tgame.objects.bracket1.color = this.randomColor();\n\t\t\t\tgame.objects.bracket2.color = this.randomColor();\n\t\t\t\tgame.objects.ball.color = this.randomColor();\n\t\t\t\tgame.objects.canvasColor = this.randomColor();\n\t\t\t},\n\n\t\t\trandomColor: function () {\n\t\t\t\tlet r = Math.floor(Math.random() * (256));\n\t\t\t\tlet g = Math.floor(Math.random() * (256));\n\t\t\t\tlet b = Math.floor(Math.random() * (256));\n\t\t\t\treturn `rgb(${r}, ${g}, ${b})`;\n\t\t\t}\n\t\t};\n\t}\n})\n"]},"metadata":{},"sourceType":"module"}